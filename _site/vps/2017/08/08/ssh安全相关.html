<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>完全小白ssh安全优化</title>
	
	<meta name="author" content="PengElement">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/pengyj">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/pengelement">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:pengelement@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/?s=35" class="img-circle" />
				PengElement
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">主页目录</a></li>
				<li><a href="/categories.html">分类</a></li>
				<li><a href="/tags.html">标签</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>主页目录</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>分类</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>标签</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/avatar/avatar.jpg" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">PengElement</a>
    </h3>
</header>


<div id="bio" class="text-center">
	be afraid of standing still
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		<!-- 

		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/pengyj">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
 -->
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/pengelement">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:pengelement@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>完全小白ssh安全优化 </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	2017.8.8
  	</span>
	  <div class="article_body">
	  <p>前几天买了个vps服务，于是玩了一把,对ssh的安全进行优化。</p>

<p>完全业余，仅供参考。</p>

<h2 id="环境">环境</h2>
<ul>
  <li>Mac OSX (终端操作)10.12.4 bash</li>
  <li>bash</li>
  <li>搬瓦工VPS Centos 6 x86 bbr</li>
</ul>

<h2 id="目标">目标</h2>

<ul>
  <li>建立普通用户权限的账户，登录后再切换为root</li>
  <li>禁用root的ssh登录权限</li>
  <li>使用rsa公钥免密登录</li>
</ul>

<h2 id="必备vi命令">必备：vi命令</h2>
<p>自行google，操作熟练后再去远程操作。</p>

<p>esc后，shift+:后，输入wq是保存退出，q!是不保存退出。</p>

<h2 id="第一次登录ssh">第一次登录ssh</h2>
<p>打开Mac的终端(Terminal), 输入</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh root@ip地址 -p 端口号
</code></pre>
</div>
<p>出现：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>The authenticity of host '[ip地址]:端口号 ([ip地址]:端口号)' can't be established.
RSA key fingerprint is SHA256:bFmpDOKQD0LH6vQYToaLgw3OjelyPHtXw6ZfN4b5XO0.
Are you sure you want to continue connecting (yes/no)? 
</code></pre>
</div>
<p>填yes</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Warning: Permanently added '[ip地址]:端口号' (RSA) to the list of known hosts.
Last login: Thu Aug  3 23:31:17 2017 from 本机ip地址
</code></pre>
</div>
<p>这时候会在本地的<code class="highlighter-rouge">~/.ssh/known_hosts</code>添加了刚刚的key，删除下次还会出现新建fingerprint的请求。</p>

<p>操作完之后，我们就登录到远程的ssh上了。</p>

<h2 id="修改登录端口和root密码">修改登录端口和root密码</h2>
<p>买了vps之后，服务商会把临时的密码和ssh端口号通过邮件发送给你。
在kiwiVM Control Panel的Main controls的SSH Port项也可以看到同样的端口号和ip地址。</p>

<p>我们需要修改一下端口号，以root的身份登录ssh之后</p>

<p>更改密码:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>passwd root
</code></pre>
</div>

<p>修改端口号:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi /etc/ssh/sshd_config
</code></pre>
</div>

<p>找到最后一句，这里的端口号就是服务商邮件发给你的那个了:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Port 端口号
</code></pre>
</div>

<p>修改完保存之后，重启sshd服务:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>service sshd restart
</code></pre>
</div>
<p>修改后回wikiVM能看到端口修改了,下次登录也只能用这个端口了。</p>

<h2 id="新建用户">新建用户</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>useradd -m 用户名
passwd 用户名
</code></pre>
</div>
<p>useradd是添加一个用户，-m是添加相关的home目录</p>

<p>passwd是为用户名改密码</p>

<p>做完之后，系统会在/home下建立一个用户名的目录。</p>

<h2 id="切换用户">切换用户</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>su 用户名
</code></pre>
</div>
<p>输入密码就能切换到指定的用户了。</p>

<p>所以当我们用自建的用户名登录后<code class="highlighter-rouge">su root</code>就能切换回root账户了。</p>

<h2 id="禁用root登录">禁用root登录</h2>
<p>登录后，以root身份操作:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi /etc/ssh/sshd_config
</code></pre>
</div>

<p>找到倒数第二句，改为no：</p>

<p><code class="highlighter-rouge">PermitRootLogin yes</code></p>

<p>wq保存，重启sshd服务（命令以上面）。</p>

<p><mark>当前已登录的账户不会强制退出，下次登录才生效。</mark></p>

<h2 id="制作免密登录">制作免密登录</h2>
<h3 id="生成密钥">生成密钥</h3>
<p>在Mac本地的terminal输入</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd ~/.ssh
ssh-keygen -t rsa -C “备注随便填”
</code></pre>
</div>
<p>会出现</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Generating public/private rsa key pair.
Enter file in which to save the key (/Users/pengyj/.ssh/id_rsa): 【直接回车】
Enter passphrase (empty for no passphrase): 【直接回车,设置空密码】
Enter same passphrase again: 【再次直接回车,确认设置空密码】
Your identification has been saved in /Users/pengyj/.ssh/id_rsa.
Your public key has been saved in /Users/pengyj/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:GeNbn307rRFeUIQ0D38+/AId4Tb2iGF7uLCa+w4qNxw “abc”
The key's randomart image is:
+---[RSA 2048]----+
|             .=oo|
|             ..B |
|        o   o B +|
|       . + . O.B.|
|        S o = =o+|
|      E  o + B oo|
|     . .o . + = +|
|    . +. +     =o|
|     o..++o   .o.|
+----[SHA256]-----+

</code></pre>
</div>
<p>操作完之后，在本机的~/.ssh/下，会出现以rsa加密的公钥<code class="highlighter-rouge">id_rsa.pub</code>和私钥<code class="highlighter-rouge">id_rsa</code>。</p>
<h3 id="导入到服务器">导入到服务器</h3>
<p>使用<code class="highlighter-rouge">ssh-copy-id</code>命令，将公钥导入到服务器。</p>

<p>在Mac本机Terminal操作，刚刚的~/.ssh 目录下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ssh-copy-id -i id_rsa.pub 用户名@ip地址 -p 端口号
</code></pre>
</div>
<p>上传成功后，后在服务器的用户名目录<code class="highlighter-rouge">~/.ssh/</code>下有一个<code class="highlighter-rouge">authorized_keys</code>文件。</p>

<p>在服务器端做修改权限（我一步我没确认过，因为我一开始就做了）：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
</code></pre>
</div>

<p>切换回root用户，或者具有root权限的用户。把以下3句注释去掉，变为:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi /etc/ssh/sshd_config
RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile	.ssh/authorized_keys
</code></pre>
</div>
<p>重启sshd服务。</p>

<p>至此，我们已经可以免密登录了。</p>

<p>在本机测试，登录，确认不用密码了后，去服务器更改关闭密码登录。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi /etc/ssh/sshd_config
PasswordAuthentication yes
</code></pre>
</div>

<h2 id="优化本机登录">优化本机登录</h2>
<p>每次在本机登录ssh，都要输入一长串的文字，于是我们优化一下，加个alias:</p>

<p>bash下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vi ~/.bash_profile
alias openvps="ssh 用户名@ip地址 -p 端口号"
</code></pre>
</div>

<p>保存重新载入</p>

<div class="highlighter-rouge"><pre class="highlight"><code>source ~/.bash_profile
</code></pre>
</div>

<p>这样我们就可以直接在本机的Terminal输入openvps就能登录到ssh了。</p>

<h2 id="保存好你的私钥">保存好你的私钥</h2>
<p>完！</p>

<h2 id="参考">参考</h2>
<p><a href="http://blog.csdn.net/tianlesoftware/article/details/6201898">Dave: Linux 修改SSH端口 和 禁止Root远程登陆</a></p>

<p><a href="https://teddysun.com/237.html">秋水逸冰: SSH无密码登录及putty设置</a></p>

<p><a href="http://www.jianshu.com/p/13919b5ba8a2">素白流殇: ssh-keygen和ssh-copy-id实现SSH无密钥登陆</a></p>

<p><a href="http://www.jianshu.com/p/ecc744c79d2f">简文：Mac 与服务器 ssh 无密码登录</a></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#vps-ref">
					vps <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#ssh-ref">
					ssh <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#安全-ref">
					安全 <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>
	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/src/jquery.qrcode.js"></script>
	<script type="text/javascript" src="/assets/src/qrcode.js"></script>
	
	<div id="qrcode"></div>
	<img id='imgQRcode'/>  
	<script>
		var qrcode= $('#qrcode').qrcode(location.href).hide(); 
		var canvas=qrcode.find('canvas').get(0);  
		$('#imgQRcode').attr('src',canvas.toDataURL('image/jpg'))  
	</script>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous disabled"><a>&larr; 较旧</a></li>
		  
		  
		  <li class="next"><a href="/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/2017/08/08/%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E9%9A%90%E8%97%8F.html" title="将文件隐藏在图片里">较新 &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2017 PengElement with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'dbyll', 'auto');
  ga('send', 'pageview');
</script>

